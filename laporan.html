<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi - Cuan-in</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; max-width: 1100px; margin: 0 auto; color: #333; }
        
        /* HEADER & KONTROL */
        .controls-area { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .header-top h1 { margin: 0; font-size: 22px; color: #1a1c23; display: flex; align-items: center; gap: 10px; }
        
        /* Filter Buttons */
        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .btn-filter { background: #e2e8f0; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; color: #4a5568; transition: 0.2s; }
        .btn-filter:hover, .btn-filter.active { background: #28a745; color: white; }
        .btn-pdf { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: auto; display: flex; align-items: center; gap: 5px; }
        .btn-pdf:hover { background: #c53030; }

        /* AREA LAPORAN */
        #report-area { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 500px; }
        
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px dashed #e2e8f0; padding-bottom: 20px; }
        .report-header h2 { margin: 0 0 5px 0; color: #2d3748; }
        .report-period { color: #718096; font-size: 14px; }

        /* Ringkasan Box */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: #f7fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .summary-label { font-size: 12px; color: #718096; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .summary-value { font-size: 24px; font-weight: bold; color: #2d3748; }
        .summary-value.green { color: #28a745; }

        /* Tabel */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
        th { background-color: #2d3748; color: white; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:nth-child(even) { background-color: #f9fafb; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; display: inline-block; margin-top: 2px; }
        .bg-green { background-color: #c6f6d5; color: #22543d; } 
        .bg-yellow { background-color: #fefcbf; color: #744210; } 
        .bg-blue { background-color: #bee3f8; color: #2b6cb0; } 
        .bg-gray { background-color: #edf2f7; color: #4a5568; }

        /* Nav */
        .nav-link { display: inline-block; margin-top: 20px; text-decoration: none; color: #718096; font-weight: 600; }
        .nav-link:hover { color: #2d3748; }
    </style>
</head>
<body>

    <div class="controls-area" data-html2canvas-ignore="true">
        <div class="header-top">
            <h1>üìä Laporan & Arsip</h1>
            <button class="btn-pdf" onclick="downloadPDF()">üñ®Ô∏è Download PDF</button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div class="filter-group">
                <button class="btn-filter active" onclick="setFilter('today', this)">Hari Ini</button>
                <button class="btn-filter" onclick="setFilter('week', this)">Minggu Ini</button>
                <button class="btn-filter" onclick="setFilter('month', this)">Bulan Ini</button>
                <button class="btn-filter" onclick="setFilter('3months', this)">3 Bulan</button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 13px; color: #666;">Atau Tanggal:</span>
                <input type="date" id="custom-date" onchange="setFilter('custom', this)" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
        </div>
    </div>

    <div id="report-area">
        <div class="report-header">
            <h2 id="store-name-display">CUAN-IN REPORT</h2>
            <p class="report-period" id="period-display">Periode: -</p>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-label">Total Omzet</div>
                <div class="summary-value green" id="total-omzet">Rp 0</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Total Transaksi</div>
                <div class="summary-value" id="total-trx">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Rata-rata / Order</div>
                <div class="summary-value" id="avg-order">Rp 0</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="15%">Waktu</th>
                    <th width="15%">No. Order</th>
                    <th width="20%">Pelanggan</th>
                    <th width="25%">Menu Items</th> <th width="10%">Metode</th>
                    <th width="15%">Total</th>
                </tr>
            </thead>
            <tbody id="tabel-laporan">
                <tr><td colspan="6" style="text-align: center; padding: 20px;">Memuat data...</td></tr>
            </tbody>
        </table>
        
        <div style="margin-top: 30px; text-align: right; font-size: 12px; color: #aaa;">
            Dicetak otomatis oleh Sistem Cuan-in pada <span id="print-date">-</span>
        </div>
    </div>

    <a href="admin.html" class="nav-link">‚¨ÖÔ∏è Kembali ke Dashboard</a>

    <script type="module">
        import { db, auth } from './firebase-config.js'; 
        import { collection, onSnapshot, query, orderBy, getDoc, doc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "login.html"; });

        let allOrders = [];
        let currentFilter = 'today';

        getDoc(doc(db, "settings", "store_config")).then(snap => {
            if(snap.exists()) document.getElementById('store-name-display').innerText = (snap.data().storeName || "CUAN-IN") + " REPORT";
        });

        const q = query(collection(db, "orders"), orderBy("created_at", "desc"));
        onSnapshot(q, (snapshot) => {
            allOrders = [];
            snapshot.forEach((doc) => {
                const d = doc.data();
                if(d.created_at) allOrders.push(d);
            });
            filterAndRender();
        });

        window.setFilter = (type, btn) => {
            currentFilter = type;
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            if(btn && type !== 'custom') btn.classList.add('active');
            filterAndRender();
        }

        function filterAndRender() {
            const today = new Date();
            let startDate = new Date();
            let endDate = new Date();
            let labelPeriode = "";

            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);

            if (currentFilter === 'today') {
                labelPeriode = formatDate(today);
            } 
            else if (currentFilter === 'week') {
                const day = startDate.getDay() || 7; 
                if(day !== 1) startDate.setHours(-24 * (day - 1));
                labelPeriode = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            }
            else if (currentFilter === 'month') {
                startDate.setDate(1);
                labelPeriode = `${formatDate(startDate)} - ${formatDate(today)}`;
            }
            else if (currentFilter === '3months') {
                startDate.setMonth(startDate.getMonth() - 3);
                labelPeriode = `${formatDate(startDate)} - ${formatDate(today)}`;
            }
            else if (currentFilter === 'custom') {
                const inputVal = document.getElementById('custom-date').value;
                if(!inputVal) return;
                startDate = new Date(inputVal);
                startDate.setHours(0,0,0,0);
                endDate = new Date(inputVal);
                endDate.setHours(23,59,59,999);
                labelPeriode = formatDate(startDate);
            }

            const filteredData = allOrders.filter(order => {
                const orderDate = new Date(order.created_at.seconds * 1000);
                return orderDate >= startDate && orderDate <= endDate;
            });

            renderUI(filteredData, labelPeriode);
        }

        function renderUI(data, label) {
            const tbody = document.getElementById('tabel-laporan');
            document.getElementById('period-display').innerText = "Periode: " + label;
            document.getElementById('print-date').innerText = new Date().toLocaleString('id-ID');

            tbody.innerHTML = "";
            let grandTotal = 0;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#888;">Tidak ada transaksi di periode ini.</td></tr>';
                updateSummary(0, 0);
                return;
            }

            data.forEach(order => {
                const total = order.grand_total || order.total_amount || 0;
                grandTotal += total;

                const dateObj = new Date(order.created_at.seconds * 1000);
                const jam = dateObj.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                const tgl = dateObj.toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});

                // Info Pelanggan & Meja
                let infoPelanggan = `<span style="font-weight:bold;">${order.customer_name || '-'}</span>`;
                if(order.order_type === 'takeaway' || order.table_number == 0) {
                    infoPelanggan += `<br><span class="badge bg-yellow">Takeaway</span>`;
                } else {
                    infoPelanggan += `<br><span class="badge bg-gray">Meja ${order.table_number}</span>`;
                }

                // Info Pembayaran
                let badgeBayar = '<span class="badge bg-gray">?</span>';
                let method = order.payment_method || 'cash';
                
                if(method === 'cash') badgeBayar = '<span class="badge bg-green">TUNAI</span>';
                else if(method === 'qris') badgeBayar = '<span class="badge bg-blue">QRIS</span>';
                else if(method === 'edc') badgeBayar = '<span class="badge bg-blue">EDC/BANK</span>';

                let refInfo = "";
                if(order.payment_ref && order.payment_ref !== '-') {
                    refInfo = `<br><small style="color:#666; font-size:10px;">Ref: ${order.payment_ref}</small>`;
                }

                // ITEM PRODUK (YANG TADI HILANG)
                const menuList = order.items.map(i => `
                    <div style="margin-bottom:3px;">
                        ‚Ä¢ ${i.name} <span style="color:#666; font-size:11px;">x${i.qty}</span>
                    </div>
                `).join("");

                tbody.innerHTML += `
                    <tr>
                        <td>${tgl} <br> <small style="color:#888">${jam}</small></td>
                        <td>${order.order_number}</td>
                        <td>${infoPelanggan}</td>
                        <td style="font-size:12px; line-height:1.4;">${menuList}</td> <td>${badgeBayar} ${refInfo}</td>
                        <td style="font-weight:bold;">Rp ${total.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            });

            updateSummary(grandTotal, data.length);
        }

        function updateSummary(omzet, trx) {
            document.getElementById('total-omzet').innerText = "Rp " + omzet.toLocaleString('id-ID');
            document.getElementById('total-trx').innerText = trx;
            const avg = trx > 0 ? Math.round(omzet / trx) : 0;
            document.getElementById('avg-order').innerText = "Rp " + avg.toLocaleString('id-ID');
        }

        function formatDate(date) {
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        window.downloadPDF = () => {
            const element = document.getElementById('report-area');
            const opt = {
                margin:       10,
                filename:     `Laporan_CuanIn_${new Date().toISOString().slice(0,10)}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        };
    </script>
</body>
</html>