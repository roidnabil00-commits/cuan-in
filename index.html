<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuan-in POS - Kasir</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2953/2953363.png">

    <style>
        :root {
            --bg-main: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0; /* Dicerahkan biar kebaca */
            --accent-purple: #764ba2;
            --accent-green: #00ff88;
            --danger: #ff4757;
            --rounded: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; height: 100vh; overflow: hidden; background-color: var(--bg-main); color: var(--text-primary); }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 10px; }

        /* INPUT & SELECT FIX (PENTING!) */
        input, select, textarea { 
            color: white !important; /* Paksa teks putih */
            background-color: var(--bg-secondary) !important;
        }
        /* Fix dropdown option biar gak putih-putih */
        option { background-color: var(--bg-main); color: white; }
        ::placeholder { color: rgba(255,255,255,0.5) !important; }

        /* LAYOUT */
        #menu-container { flex: 2; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); }
        #cart-container { flex: 1; padding: 20px; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); }

        /* HEADER */
        .header-kasir { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-kasir h2 { font-weight: 700; color: var(--accent-green); }

        /* TABS */
        .category-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .cat-btn { background: var(--bg-secondary); border: 1px solid rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; cursor: pointer; color: var(--text-secondary); transition: 0.3s; white-space: nowrap; }
        .cat-btn:hover, .cat-btn.active { background: var(--accent-purple); color: white; border-color: var(--accent-purple); }

        /* MENU GRID */
        #daftar-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; padding-bottom: 20px; }
        .card { background: var(--bg-secondary); padding: 15px; border-radius: var(--rounded); cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 110px; }
        .card:hover { transform: translateY(-3px); border-color: var(--accent-green); }
        .card h3 { font-size: 14px; color: white; margin-bottom: 5px; }
        .price { color: var(--accent-green); font-weight: bold; }

        /* INPUT PELANGGAN */
        .order-info { margin-bottom: 15px; background: var(--bg-secondary); padding: 10px; border-radius: var(--rounded); border: 1px solid rgba(255,255,255,0.1); }
        .modern-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: var(--bg-main); outline: none; }
        
        /* CART ITEM */
        #cart-items { flex: 1; overflow-y: auto; margin-bottom: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; }
        
        /* TOTAL & BUTTON */
        .total-section { background: var(--bg-secondary); padding: 15px; border-radius: var(--rounded); margin-bottom: 15px; text-align: center; }
        .btn-bayar { background: var(--accent-green); color: #000; border: none; padding: 15px; width: 100%; font-weight: 800; border-radius: var(--rounded); cursor: pointer; font-size: 16px; }
        .btn-bayar:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* MODAL */
        #modal-payment, #modal-struk { background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-secondary); width: 400px; padding: 25px; border-radius: 20px; text-align: center; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-method { flex: 1; padding: 12px; background: var(--bg-main); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; cursor: pointer; margin: 0 2px; }
        
        /* STRUK (TETAP PUTIH BIAR DIPRINT JELAS) */
        .struk-box { background: white; color: black; padding: 20px; width: 320px; border-radius: 10px; font-family: monospace; }
        
        /* BUTTONS */
        .btn-logout { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 5px 15px; border-radius: 20px; cursor: pointer; }
        .btn-clear { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px; text-decoration: underline; }
        
        /* --- CSS KHUSUS PRINT (TAMBAHKAN INI) --- */
@media print {
    /* Sembunyikan semua elemen utama */
    body * {
        visibility: hidden; 
    }
    
    /* Munculkan hanya Modal Struk */
    #modal-struk, #modal-struk * {
        visibility: visible;
    }

    /* Atur posisi struk biar pas di kertas */
    #modal-struk {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: auto;
        background: white; /* Paksa background putih */
        color: black;
        backdrop-filter: none;
    }

    /* Sembunyikan tombol Print & Tutup saat nge-print */
    #modal-struk button {
        display: none !important;
    }

    /* Hilangkan margin browser biar kertas pas */
    @page {
        margin: 0;
        size: auto; 
    }
}
   </style>
</head>
<body>

    <div id="menu-container">
        <div class="header-kasir">
            <h2>üöÄ Cuan-in</h2>
            <button class="btn-logout" onclick="logout()">LOGOUT</button>
        </div>

        <div class="category-tabs" id="cat-tabs">
            <button class="cat-btn active" onclick="filterMenu('all', this)">Semua</button>
            <button class="cat-btn" onclick="filterMenu('Coffee', this)">Coffee</button>
            <button class="cat-btn" onclick="filterMenu('Non-Coffee', this)">Non-Coffee</button>
            <button class="cat-btn" onclick="filterMenu('Makanan', this)">Makanan</button>
            <button class="cat-btn" onclick="filterMenu('Snack', this)">Snack</button>
        </div>

        <div id="daftar-menu"></div>
    </div>

    <div id="cart-container">
        <div class="header-kasir">
            <h3>Pesanan</h3>
            <button class="btn-clear" onclick="clearCart()">Hapus Semua</button>
        </div>

        <div class="order-info">
            <select id="order-type" onchange="toggleTableInput()" class="modern-input">
                <option value="dine-in">üçΩÔ∏è Dine In</option>
                <option value="takeaway">ü•° Takeaway</option>
            </select>
            <div style="display:flex; gap:5px;">
                <input type="text" id="cust-name" placeholder="Nama Pelanggan" class="modern-input" style="flex:2">
                <input type="number" id="table-num" placeholder="Meja" class="modern-input" style="flex:1">
            </div>
        </div>

        <div id="cart-items">
            <div style="text-align:center; color:rgba(255,255,255,0.3); margin-top:50px;">Belum ada pesanan</div>
        </div>

        <div class="total-section" id="total-price" style="font-size:14px; color:#aaa;">
            Total akan muncul di sini
        </div>
        <button id="btn-checkout" class="btn-bayar" disabled>
            BAYAR <span id="btn-total">Rp 0</span>
        </button>
    </div>

    <div id="modal-payment" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; z-index: 1001;">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Pembayaran</h3>
            <h1 id="pay-total-display" style="color:var(--accent-green); margin-bottom:20px;">Rp 0</h1>
            
            <div style="display:flex; margin-bottom:20px;">
                <button onclick="setPaymentMethod('cash')" id="btn-cash" class="btn-method">Tunai</button>
                <button onclick="setPaymentMethod('qris')" id="btn-qris" class="btn-method">QRIS</button>
                <button onclick="setPaymentMethod('edc')" id="btn-edc" class="btn-method">EDC</button>
            </div>

            <div id="area-cash">
                <input type="text" id="pay-input" placeholder="Input Nominal" onkeyup="calcChange(this)" class="modern-input" style="text-align:center; font-size:18px;">
                <div style="margin:15px 0; color:#aaa;">Kembali: <span id="pay-change" style="color:var(--accent-green); font-weight:bold; font-size:20px;">Rp 0</span></div>
                <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                    <button onclick="fastCash(20000)" class="btn-method" style="flex:unset; padding:5px 10px; font-size:12px;">20k</button>
                    <button onclick="fastCash(50000)" class="btn-method" style="flex:unset; padding:5px 10px; font-size:12px;">50k</button>
                    <button onclick="fastCash(100000)" class="btn-method" style="flex:unset; padding:5px 10px; font-size:12px;">100k</button>
                    <button onclick="fastCash('pas')" class="btn-method" style="flex:unset; padding:5px 10px; font-size:12px; background:var(--accent-purple);">Uang Pas</button>
                </div>
            </div>

            <div id="area-qris" style="display:none;">
                <div style="background:white; padding:10px; display:inline-block; border-radius:10px;">
                    <img src="https://via.placeholder.com/150?text=QRIS" width="150">
                </div>
                <p style="font-size:12px; color:#aaa; margin-top:10px;">Scan QRIS di atas</p>
            </div>

            <div id="area-edc" style="display:none;">
                <input type="text" id="edc-ref" placeholder="No. Ref Transaksi" class="modern-input">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closePayment()" class="btn-method" style="background:rgba(255,255,255,0.1);">Batal</button>
                <button onclick="processFinalPayment()" class="btn-method" style="background:var(--accent-green); color:black; font-weight:bold; flex:2;">PROSES</button>
            </div>
        </div>
    </div>

    <div id="modal-struk" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; z-index: 1002;">
        <div class="struk-box">
            <div class="struk-header" style="border-bottom:2px dashed #000; padding-bottom:10px; margin-bottom:10px;">
                <h2 style="margin:0;">CUAN-IN</h2>
                <p style="margin:0; font-size:12px;">Jl. Koding No. 1</p>
            </div>
            <div id="struk-content" style="text-align:left; font-size:12px; margin-bottom:10px;"></div>
            <div style="border-top:2px dashed #000; padding-top:10px; display:flex; justify-content:space-between; font-weight:bold;">
                <span>TOTAL</span><span id="struk-total-price">Rp 0</span>
            </div>
            <div class="struk-footer" style="margin-top:20px; font-size:10px; color:#555;">
                <p>Terima Kasih!</p>
                <p id="struk-date">-</p>
                <p id="struk-id">#</p>
            </div>
            <button onclick="window.print()" style="width:100%; padding:10px; background:#333; color:white; border:none; margin-top:10px; cursor:pointer;">PRINT</button>
            <button id="btn-tutup-struk" style="width:100%; padding:10px; background:none; border:1px solid red; color:red; margin-top:5px; cursor:pointer;">TUTUP</button>
        </div>
    </div>

    <script type="module">
        // Import auth dari settingan database kita
        import { auth } from './db-config.js'; 

        const loginForm = document.getElementById('login-form');
        const errorMsg = document.getElementById('error-msg');
        const btnLogin = document.getElementById('btn-login');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // UI Loading
            btnLogin.innerText = "Memproses...";
            btnLogin.disabled = true;
            errorMsg.style.display = "none";

            try {
                // 1. Cek ke Supabase: Apakah email & password benar?
                const { data, error } = await auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                // 2. Jika Benar: Simpan role owner (opsional) & Pindah halaman
                // Supabase otomatis menyimpan sesi login di browser (Cookies/Storage)
                localStorage.setItem('user_role', 'owner'); 
                window.location.href = "admin.html";

            } catch (error) {
                // 3. Jika Salah
                console.error("Login Gagal:", error.message);
                errorMsg.style.display = "block";
                errorMsg.innerText = "‚ùå Email atau Password Salah!";
                btnLogin.innerText = "MASUK";
                btnLogin.disabled = false;
            }
        });
    </script>
    <script type="module">
        import { auth } from './db-config.js';

        // Cek Login Supabase
        async function checkAuth() {
            const { data: { session } } = await auth.getSession();
            if (!session) {
                window.location.href = "login.html";
            }
        }
        checkAuth();

        // Fungsi Logout
        window.logout = async () => { 
            if(confirm("Tutup kasir & logout?")) {
                await auth.signOut();
                localStorage.removeItem('user_role');
                window.location.href = "login.html"; 
            }
        };
    </script>
</body>
</html>