<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Keuangan - Cuan-in</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS ASLI ANDA (TIDAK DIUBAH) */
        body { font-family: 'Poppins', sans-serif; background: #1a1a2e; color: white; padding: 20px; }
        
        .controls { background: #16213e; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-filter { background: #1a1a2e; border: 1px solid #555; color: #ccc; padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .btn-filter.active, .btn-filter:hover { background: #00ff88; color: black; border-color: #00ff88; font-weight: bold; }
        
        .search-box { margin-top: 15px; display: flex; gap: 10px; }
        .input-search { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #0f3460; color: white; outline: none; }
        
        #report-area { background: white; color: #333; padding: 40px; border-radius: 5px; min-height: 600px; max-width: 1100px; margin: 0 auto; box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow-x: auto; }
        
        .summary-box { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap:wrap; }
        .s-card { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd; min-width: 150px; }
        .s-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .s-val { font-size: 20px; font-weight: bold; color: #333; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 20px; }
        th { background: #333; color: white; padding: 12px; text-align: left; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
        tr:hover { background-color: #f9f9f9; }

        .badge-pay { padding: 3px 8px; border-radius: 5px; font-weight: bold; font-size: 10px; text-transform: uppercase; color: white; }
        .bg-cash { background: #28a745; } 
        .bg-qris { background: #6f42c1; } 
        .bg-edc { background: #007bff; }

        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ccc; }
        .btn-page { padding: 8px 15px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-page:disabled { background: #ccc; cursor: not-allowed; }

        .btn-void { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .btn-void:hover { background: #d63031; transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="controls">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>üìä Laporan Keuangan</h2>
            <button onclick="downloadPDF()" style="background:#e74c3c; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">üìÑ Download PDF (Teks)</button>
        </div>
        
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn-filter active" onclick="setFilter('today', this)">Hari Ini</button>
            <button class="btn-filter" onclick="setFilter('week', this)">Minggu Ini</button>
            <button class="btn-filter" onclick="setFilter('month', this)">Bulan Ini</button>
            <input type="date" id="custom-date" onchange="setFilter('custom', this)" style="padding:7px; border-radius:15px; border:none; color:black; background:white;">
        </div>

        <div class="search-box">
            <input type="text" id="search-input" class="input-search" placeholder="üîç Cari Order ID atau Nama..." onkeyup="handleSearch(event)">
            <button onclick="loadReportData()" style="padding:0 20px; background:#00ff88; color:black; font-weight:bold; border:none; border-radius:10px; cursor:pointer;">CARI</button>
        </div>

        <a href="admin.html" style="display:inline-block; margin-top:15px; color:#aaa; text-decoration:none;">‚¨ÖÔ∏è Kembali ke Dashboard</a>
    </div>

    <div id="report-area">
        <div style="text-align:center; border-bottom:2px double #333; padding-bottom:20px; margin-bottom:20px;">
            <h2 id="store-name" style="margin:0;">LAPORAN TRANSAKSI</h2>
            <p id="period-display" style="margin:5px 0; color:#666;">Periode: -</p>
        </div>

        <div class="summary-box">
            <div class="s-card">
                <div class="s-label">Total Penjualan (Omzet)</div>
                <div class="s-val" id="tot-omzet" style="color:#28a745;">Rp 0</div>
                <small style="font-size:9px; color:#888;">(Termasuk Tax & Service)</small>
            </div>
            <div class="s-card" style="border:1px solid #17a2b8; background:#e0f7fa;">
                <div class="s-label">Penjualan Bersih (Net)</div>
                <div class="s-val" id="tot-net" style="color:#17a2b8;">Rp 0</div>
                <small style="font-size:9px; color:#666;">(Subtotal Murni)</small>
            </div>
            <div class="s-card" style="border:1px solid #764ba2; background:#f3e5f5;">
                <div class="s-label">üí∞ PROFIT BERSIH</div>
                <div class="s-val" id="tot-profit" style="color:#764ba2;">Rp 0</div>
                <small style="font-size:9px; color:#666;">(Net Sales - Modal)</small>
            </div>
            <div class="s-card">
                <div class="s-label">Jumlah Transaksi</div>
                <div class="s-val" id="tot-trx">0</div>
            </div>
        </div>

        <div class="summary-box">
            <div class="s-card" style="background:#e8f5e9; border:1px solid #28a745;">
                <div class="s-label">üíµ CASH (LACI)</div>
                <div class="s-val" id="pay-cash">Rp 0</div>
            </div>
            <div class="s-card" style="background:#e3f2fd; border:1px solid #007bff;">
                <div class="s-label">üí≥ EDC (BANK)</div>
                <div class="s-val" id="pay-edc">Rp 0</div>
            </div>
            <div class="s-card" style="background:#f3e5f5; border:1px solid #6f42c1;">
                <div class="s-label">üì± QRIS (BANK)</div>
                <div class="s-val" id="pay-qris">Rp 0</div>
            </div>
        </div>
        
        <table id="report-table">
            <thead>
                <tr>
                    <th>Waktu (WIB)</th>
                    <th>No. Order</th>
                    <th>Pelanggan</th>
                    <th>Metode</th>
                    <th>Items</th>
                    <th style="text-align:right;">Subtotal</th>
                    <th style="text-align:right;">Diskon</th>
                    <th style="text-align:right;">Total Akhir</th>
                    <th style="text-align:center; width:50px;" class="no-print">Aksi</th>
                </tr>
            </thead>
            <tbody id="tabel-laporan"></tbody>
        </table>

        <div class="pagination" id="pagination-controls">
            <button class="btn-page" id="prev-btn" onclick="changePage(-1)">Previous</button>
            <span style="color:black; align-self:center;">Halaman <span id="curr-page">1</span></span>
            <button class="btn-page" id="next-btn" onclick="changePage(1)">Next</button>
        </div>
        
        <div style="margin-top:20px; font-size:10px; color:#666; font-style:italic;">
            * Omzet = Subtotal + Pajak + Service - Diskon<br>
            * Net Sales (Subtotal) = Penjualan Murni Barang<br>
            * Profit = Net Sales (Subtotal) - Modal (HPP)<br>
        </div>
        <div style="text-align:right; font-size:10px; color:#aaa; margin-top:10px;">Dicetak: <span id="print-date"></span></div>
    </div>

    <script type="module">
        import { db, auth } from './db-config.js';

        let storeId = localStorage.getItem('store_id');
        let currentStartDate = "";
        let currentEndDate = "";
        let currentPage = 1;
        const itemsPerPage = 20;

        // Load Header Toko
        async function init() {
            if(!storeId) {
                const { data: { user } } = await auth.getUser();
                if(!user) window.location.href='login.html';
            }
            db.from('settings').select('*').eq('store_id', storeId).single().then(({ data }) => {
                if(data) document.getElementById('store-name').innerText = (data.store_name || "CUAN-IN") + " REPORT";
            });
            // Default filter hari ini
            setFilter('today', document.querySelector('.btn-filter'));
        }

        // [UPGRADE] LOGIKA FILTER WAKTU (FIX TIMEZONE WIB)
        window.setFilter = (type, btn) => {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            if(btn && btn.tagName === 'BUTTON') btn.classList.add('active');

            // Helper: Ambil tanggal Jakarta (YYYY-MM-DD)
            const getJakartaDate = (dateObj) => dateObj.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
            const now = new Date();
            let startStr, endStr, label;

            if(type === 'today') {
                const today = getJakartaDate(now);
                startStr = `${today}T00:00:00+07:00`;
                endStr = `${today}T23:59:59+07:00`;
                label = "Hari Ini (WIB)";
            } 
            else if(type === 'week') {
                const day = now.getDay() || 7; 
                const monday = new Date(now);
                monday.setDate(now.getDate() - day + 1);
                startStr = `${getJakartaDate(monday)}T00:00:00+07:00`;
                endStr = `${getJakartaDate(now)}T23:59:59+07:00`;
                label = "Minggu Ini (WIB)";
            } 
            else if(type === 'month') {
                const y = now.getFullYear();
                const m = now.getMonth() + 1;
                const firstDay = `${y}-${String(m).padStart(2,'0')}-01`;
                const today = getJakartaDate(now);
                startStr = `${firstDay}T00:00:00+07:00`;
                endStr = `${today}T23:59:59+07:00`;
                label = "Bulan Ini (WIB)";
            } 
            else if(type === 'custom') {
                const val = document.getElementById('custom-date').value;
                if(!val) return; 
                startStr = `${val}T00:00:00+07:00`;
                endStr = `${val}T23:59:59+07:00`;
                label = "Tanggal: " + val;
            }

            currentStartDate = startStr;
            currentEndDate = endStr;

            document.getElementById('period-display').innerText = label;
            // Jam cetak versi WIB
            document.getElementById('print-date').innerText = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });

            currentPage = 1;
            loadReportData();
        };

        window.handleSearch = (e) => { if (e.key === 'Enter') loadReportData(); }

        window.loadReportData = async () => {
            if(!currentStartDate || !currentEndDate) return;
            const searchTerm = document.getElementById('search-input').value.trim();

            // 1. AMBIL SUMMARY (LOGIKA ASLI ANDA)
            let querySum = db.from('orders')
                .select('grand_total, subtotal, total_cost, payment_method, discount_amount')
                .eq('store_id', storeId)
                .gte('created_at', currentStartDate)
                .lte('created_at', currentEndDate); 
            
            if(searchTerm) querySum = querySum.or(`order_number.ilike.%${searchTerm}%,customer_name.ilike.%${searchTerm}%`);

            const { data: summaryData } = await querySum;
            
            if(summaryData) {
                let totalOmzet = 0, totalNet = 0, totalProfit = 0;
                let cashTotal = 0, qrisTotal = 0, edcTotal = 0;

                summaryData.forEach(curr => {
                    const gTotal = curr.grand_total || 0;
                    const subTotal = curr.subtotal || 0;
                    const tCost = curr.total_cost || 0;
                    const method = (curr.payment_method || '').toUpperCase();

                    totalOmzet += gTotal;         
                    totalNet += subTotal;         
                    totalProfit += (subTotal - tCost); 

                    if(method.includes('CASH') || method.includes('TUNAI')) cashTotal += gTotal;
                    else if(method.includes('QRIS')) qrisTotal += gTotal;
                    else if(method.includes('EDC')) edcTotal += gTotal;
                });
                
                document.getElementById('tot-omzet').innerText = "Rp " + totalOmzet.toLocaleString('id-ID');
                document.getElementById('tot-net').innerText = "Rp " + totalNet.toLocaleString('id-ID');
                document.getElementById('tot-profit').innerText = "Rp " + totalProfit.toLocaleString('id-ID');
                document.getElementById('tot-trx').innerText = summaryData.length;

                document.getElementById('pay-cash').innerText = "Rp " + cashTotal.toLocaleString('id-ID');
                document.getElementById('pay-qris').innerText = "Rp " + qrisTotal.toLocaleString('id-ID');
                document.getElementById('pay-edc').innerText = "Rp " + edcTotal.toLocaleString('id-ID');
            }

            // 2. AMBIL DATA TABEL (PAGINATION)
            const from = (currentPage - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;

            let queryTable = db.from('orders')
                .select(`*, order_items(*)`)
                .eq('store_id', storeId)
                .gte('created_at', currentStartDate)
                .lte('created_at', currentEndDate)
                .order('created_at', {ascending:false})
                .range(from, to);

            if(searchTerm) queryTable = queryTable.or(`order_number.ilike.%${searchTerm}%,customer_name.ilike.%${searchTerm}%`);

            const { data: tableData, error } = await queryTable;
            const tbody = document.getElementById('tabel-laporan'); 
            tbody.innerHTML = "";

            if(error) return alert("Error: " + error.message);

            if(tableData && tableData.length > 0) {
                tableData.forEach(d => {
                    const dateObj = new Date(d.created_at);
                    const tanggal = dateObj.toLocaleDateString('id-ID', {timeZone: 'Asia/Jakarta'}); 
                    const waktu = dateObj.toLocaleTimeString('id-ID', {timeZone: 'Asia/Jakarta', hour: '2-digit', minute:'2-digit'});
                    
                    const itemsStr = d.order_items.map(i => `${i.product_name} (${i.qty})`).join("<br>");
                    
                    let methodClass = 'bg-cash';
                    if(d.payment_method && d.payment_method.toLowerCase().includes('qris')) methodClass = 'bg-qris';
                    if(d.payment_method && d.payment_method.toLowerCase().includes('edc')) methodClass = 'bg-edc';

                    const discAmt = d.discount_amount || 0;

                    tbody.innerHTML += `
                        <tr>
                            <td>${tanggal}<br><span style="color:#888;font-size:10px;">${waktu}</span></td>
                            <td style="font-weight:bold; color:#555;">${d.order_number}</td>
                            <td>${d.customer_name}</td>
                            <td><span class="badge-pay ${methodClass}">${d.payment_method}</span></td>
                            <td style="font-size:11px; color:#555;">${itemsStr}</td>
                            <td style="text-align:right;">${d.subtotal.toLocaleString('id-ID')}</td>
                            <td style="text-align:right; color:${discAmt>0 ? '#ff4757' : '#ccc'};">
                                ${discAmt > 0 ? '-' + discAmt.toLocaleString('id-ID') : '0'}
                            </td>
                            <td style="text-align:right; font-weight:bold;">Rp ${d.grand_total.toLocaleString('id-ID')}</td>
                            <td style="text-align:center;" class="no-print">
                                <button class="btn-void" onclick="voidTransaction(${d.id})" title="Hapus Transaksi">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:20px;">Data tidak ditemukan</td></tr>`;
            }

            document.getElementById('curr-page').innerText = currentPage;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = !tableData || tableData.length < itemsPerPage;
        };

        window.changePage = (delta) => { currentPage += delta; loadReportData(); };

        // [UPGRADE] DOWNLOAD PDF TEXT-BASED (Jauh lebih rapi daripada html2pdf)
        window.downloadPDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

            // 1. Header
            const storeName = document.getElementById('store-name').innerText;
            const periode = document.getElementById('period-display').innerText;
            const totOmzet = document.getElementById('tot-omzet').innerText;
            
            doc.setFontSize(16); doc.text(storeName, 14, 15);
            doc.setFontSize(10); doc.text(`Periode: ${periode}`, 14, 22);
            doc.text(`Total Omzet: ${totOmzet}`, 14, 27);

            // 2. Generate Tabel Otomatis
            doc.autoTable({
                startY: 35,
                html: '#report-table', // Ambil data dari HTML tabel
                theme: 'striped',
                headStyles: { fillColor: [22, 33, 62] }, // Warna Navy sesuai tema
                columns: [
                    { header: 'Waktu', dataKey: 0 },
                    { header: 'No Order', dataKey: 1 },
                    { header: 'Pelanggan', dataKey: 2 },
                    { header: 'Metode', dataKey: 3 },
                    { header: 'Item', dataKey: 4 },
                    { header: 'Subtotal', dataKey: 5, halign:'right' },
                    { header: 'Disc', dataKey: 6, halign:'right' },
                    { header: 'Total', dataKey: 7, halign:'right' }
                    // Kolom Aksi (ke-8) otomatis di-skip karena logic autoTable biasanya smart, atau kita filter nanti
                ],
                didParseCell: function(data) {
                    // Hapus kolom aksi dari PDF
                    if (data.column.index === 8) {
                        data.cell.styles.display = 'none'; // Sembunyikan kolom tombol sampah
                    }
                    // Bersihkan teks Item dari HTML tag <br>
                    if (data.column.index === 4 && typeof data.cell.raw === 'object') {
                       // AutoTable handle html inner text
                    }
                }
            });

            // 3. Save
            doc.save(`Laporan_${periode.replace(/ /g,'_')}.pdf`);
        };

        // VOID TRANSACTION (LOGIKA ASLI ANDA - TETAP ADA)
        window.voidTransaction = async (orderId) => {
            if(!confirm("‚ö†Ô∏è PERINGATAN: Hapus transaksi ini? Stok akan dikembalikan.")) return;
            try {
                const { data: items } = await db.from('order_items').select('*').eq('order_id', orderId);
                for(let item of items) {
                    const { data: prod } = await db.from('products').select('stock').eq('id', item.product_id).single();
                    if(prod) await db.from('products').update({ stock: prod.stock + item.qty }).eq('id', item.product_id);
                }
                await db.from('orders').delete().eq('id', orderId);
                alert("‚úÖ Transaksi dihapus & Stok kembali!");
                loadReportData();
            } catch (err) {
                alert("Gagal: " + err.message);
            }
        };

        init();
    </script>
</body>
</html>